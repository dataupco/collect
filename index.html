<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width">
    <title>Data Up!</title>
    <script>
  function setup() {
     //var signinLink = $('#signin');
     var signinLink = document.getElementById('signin');
     if (signinLink) {
       signinLink.onclick = function() { navigator.id.request(); };
     }

     //var signoutLink = $('#signout');
     var signoutLink = document.getElementById('signout');
     if (signoutLink) {
       signoutLink.onclick = function() { alert('fire'); navigator.id.logout(); };
     }

     var toggleLoginLinks = function(email) {
       var hideLink = '#signin';
       var showLink = '#signout';

       if(email==null) {
         email = 'Guest';
         hideLink = '#signout';
         showLink = '#signin';
       }

       $(hideLink).hide();
       $(showLink).show();
       $('#usergreeting').html('Welcome ' + email + '!');
     };

     navigator.id.watch({
       onlogin : function(assertion) { 
         $.ajax({ 
            type: 'POST',
            url: '/auth/login', 
            data: {assertion: assertion},
            success: function(res, status, xhr) { 
              //alert('login success : ' + JSON.stringify(res)); 
              toggleLoginLinks(res.email.substring(0,res.email.indexOf('@')));
            },
            error: function(xhr, status, err) {
              alert("Login failure: " + err);
              toggleLoginLinks(null);
              navigator.id.logout();
             }
         });
       },
       onlogout : function(assertion) {
         $.ajax({
           type: 'POST',
           url: '/auth/logout', 
           success: function(res, status, xhr) { 
             toggleLoginLinks(null);
           },
           error: function(xhr, status, err) { 
             alert("Logout failure: " + err); 
             toggleLoginLinks(null);
           }
         });
       }
     });
  }
    </script>
  </head>
  <body onLoad="setup()">
    <div> 
      <span id="usergreeting"> </span>
      <span id="userlogin">
        <a id="signin" style="display:none" href="#">Sign In</a>
        <a id="signout" style="display:none" href="#">Sign Out</a>
      </span>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://login.persona.org/include.js"></script>
  </body>
</html>
